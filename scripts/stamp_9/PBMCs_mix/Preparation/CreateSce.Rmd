---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r}
# Libraries
suppressPackageStartupMessages({
library(SingleCellExperiment)
library(tidyverse)
library(dplyr)
library(here)
library(scater)
library(scuttle)
library(glue)
library(qs)
library(scran)
library(BiocParallel)
library(BiocNeighbors)
library(BiocSingular)
library(data.table)
})
```


```{r}
dir <- glue("{here()}")
# Parameters and paths
source(glue("{dir}/scripts/misc/paths.R"))
source(glue("{dir}/scripts/misc/BIN.R"))
```



```{r}
sample <- "PBMCs_mix"
sname <- "output-XETG00067__0007171__PBMCs_Mix__20240731__090055"
data_dir <- glue("{proj_dir}/data/stamp_9/{sample}/raw/{sname}")
counts <- Matrix::readMM(gzfile(glue("{data_dir}/cell_feature_matrix/matrix.mtx.gz")))
barcodes <- fread(glue("{data_dir}/cell_feature_matrix/barcodes.tsv.gz"), sep = "\t", nThread = 3, header = F)
features <- fread(glue("{data_dir}/cell_feature_matrix/features.tsv.gz"), sep = "\t", nThread = 3, header = F)
```


```{r}
counts <- as(counts, "dgCMatrix")
```

```{r}
colnames(counts) <- barcodes$V1
rownames(counts) <- features$V2
```


```{r}
md <- fread(glue("{data_dir}/cells.csv.gz"), sep = ",", nThread = 5, header = T)
```


```{r}
# isolate negative control matrices:
NegControlProbe <- counts[grepl("NegControlProbe", rownames(counts)) ,]
NegControlCodeword <- counts[grepl("NegControlCodeword", rownames(counts)) ,]
UnassignedCodeword <- counts[grepl("UnassignedCodeword", rownames(counts)) ,]
```

```{r}
counts <- counts[ !grepl("NegControlProbe", rownames(counts)) &
                   !grepl("NegControlCodeword", rownames(counts)) &
                   !grepl("UnassignedCodeword", rownames(counts)),]
```


```{r}
sce <- SingleCellExperiment(assays = list(counts = counts), colData = md)
```

```{r}
metadata(sce)$UnassignedCodeword <- UnassignedCodeword
metadata(sce)$NegControlCodeword <- NegControlCodeword
metadata(sce)$NegControlProbe <- NegControlProbe
```

```{r}
colnames(colData(sce))
```

```{r}
proj_dir
```

```{r}
res_dir <-  glue("{proj_dir}/data/stamp_9/{sample}/processed")
dir.create(res_dir, showWarnings = F)
qsave(sce, file = glue("{res_dir}/raw_sce.qs"), nthreads = 8)
```

```{r}
sessionInfo()
```
